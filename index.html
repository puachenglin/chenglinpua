<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Set Firestore log level for debugging
    setLogLevel('debug');

    // --- GLOBAL VARIABLES & INITIALIZATION ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app, db, auth, userId = null;
    let isAuthReady = false;
    let isEditMode = false;
    let themeColorHex = '#3B82F6'; // Default Tailwind Indigo 500

    const CONFIG_PATH = (uid) => `artifacts/${appId}/users/${uid}/website_settings/settings`;
    const CONTENT_PATH = `artifacts/${appId}/public/data/website_content/main_data`;

    // --- DATA STRUCTURE & INITIAL DATA ---
    const initialContent = {
        research: {
            main_intro: "Welcome! I specialize in advanced electron microscopy techniques, focusing on pushing the limits of imaging complex materials. My work involves both novel experimental setups and sophisticated data analysis.",
            sub_topics: [
                { title: "Imaging Lunar Samples", content: "What do solar flare tracks look like" },
                { title: "Imaging Hydrogen Atoms", content: "Better atomic scale imaging of hydrogens" },
                { title: "Offshore Launching Platform", content: "Influence of hydrogen combustion and its mitigation on offshore launch platforms" }
            ]
        },
        personal_life: [
            { title: "Japan Kyoto", content: "It was my first time in Japan (June 2025), and I was incredibly lucky to meet my idol, Jay Chou, while I was there!", images: ["https://raw.githubusercontent.com/puachenglin/chenglinpua_website/main/media/travel/jay_chou.jpg"] },
            { title: "Silicon Valley, USA", content: "Photos from my trip to Silicon Valley, Stanford, during November 2024.", images: ["https://raw.githubusercontent.com/puachenglin/chenglinpua_website/main/media/travel/jay_chou.jpg"] }
        ],
        gallery_albums: [
            { title: "Nature Photography", type: "photo", items: ["https://placehold.co/400x400/10b981/FFFFFF?text=Forest+Scene", "https://placehold.co/400x400/f59e0b/FFFFFF?text=Sunset"] },
            { title: "Ptychography Videos", type: "video", items: ["https://www.youtube.com/embed/dQw4w9WgXcQ", "https://www.bilibili.com/video/BV1gA411u7d9/"] }
        ],
        articles: [
            { title: "The Future of Low-Dose Microscopy", source: "Science Today Magazine", link: "https://example.com/article1" },
            { title: "Why I Love Travel: A Personal Reflection", source: "Local Gazette", link: "https://example.com/article2" }
        ],
        social_links: [
            { name: "ResearchGate", url: "https://www.researchgate.net/profile/Pua-Chenglin/" },
            { name: "Google Scholar", url: "https://scholar.google.com/citations?user=OSv_Bm4AAAAJ&hl=en/" },
            { name: "YouTube", url: "https://www.youtube.com/@AtomiMuseum/" },
            { name: "BiliBili", url: "https://space.bilibili.com/3493105227533275/" },
        ]
    };

    // --- CAROUSEL/SLIDER LOGIC ---

    /** Initializes an automatic, vertical-aspect-ratio image slider for each memory. */
    function initImageSliders() {
        document.querySelectorAll('.image-slider-container').forEach(container => {
            const images = container.querySelectorAll('img');
            let currentIndex = 0;
            const intervalTime = 5000; // 5 seconds per image

            // Initially show only the first image
            images.forEach((img, index) => {
                img.style.opacity = index === 0 ? 1 : 0;
                img.style.display = index === 0 ? 'block' : 'none';
            });

            // Start the auto-advance logic
            setInterval(() => {
                // Hide current image
                images[currentIndex].style.opacity = 0;
                images[currentIndex].style.display = 'none';

                // Move to next image
                currentIndex = (currentIndex + 1) % images.length;

                // Show next image with a fade-in effect
                images[currentIndex].style.display = 'block';
                setTimeout(() => {
                    images[currentIndex].style.opacity = 1;
                }, 50); // Small delay for fade effect
            }, intervalTime);
        });
    }

    // --- CORE UI FUNCTIONS ---

    /** Toggles the edit mode and updates the UI. */
    function toggleEditMode(enable) {
        isEditMode = enable;
        const toggleButton = document.getElementById('edit-mode-toggle');
        const editableElements = document.querySelectorAll('.content-editable-field');

        if (isEditMode) {
            toggleButton.textContent = 'Exit Edit Mode';
            toggleButton.classList.remove('bg-white', 'text-gray-800');
            toggleButton.classList.add('bg-red-500', 'text-white');
            editableElements.forEach(el => {
                el.setAttribute('contenteditable', 'true');
                el.style.cursor = 'text';
            });
            // Show config button/options
            const configButton = document.createElement('button');
            configButton.id = 'config-btn';
            configButton.innerHTML = '⚙️ Config';
            configButton.className = 'px-4 py-2 text-sm font-medium rounded-full bg-yellow-400 text-gray-900 hover:bg-yellow-500 transition duration-150 shadow-md ml-4';
            configButton.onclick = () => document.getElementById('config-modal').classList.remove('hidden');
            document.getElementById('edit-mode-toggle').parentElement.appendChild(configButton);

        } else {
            toggleButton.textContent = 'Enable Edit Mode';
            toggleButton.classList.add('bg-white', 'text-gray-800');
            toggleButton.classList.remove('bg-red-500', 'text-white');
            editableElements.forEach(el => {
                el.removeAttribute('contenteditable');
                el.style.cursor = 'default';
            });
            const configBtn = document.getElementById('config-btn');
            if (configBtn) configBtn.remove();
            // Save content when exiting edit mode
            saveContent();
        }
    }

    /** Renders the entire website content based on the provided data. */
    function renderContent(data) {
        document.getElementById('loading-indicator').classList.add('hidden');
        if (!data) data = initialContent; // Fallback to initial data if snapshot is empty

        // --- 1. RESEARCH SECTION ---
        document.getElementById('research-main-intro').textContent = data.research.main_intro || initialContent.research.main_intro;
        document.getElementById('research-main-intro').dataset.key = 'research.main_intro';

        const researchContainer = document.getElementById('research-sub-topics');
        researchContainer.innerHTML = data.research.sub_topics.map((topic, i) => `
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4" style="border-top-color: var(--theme-color-500, #3b82f6);">
                <h4 class="text-xl font-semibold mb-3" style="color: var(--theme-color-600, #4f46e5);"
                    id="research-sub-topics-${i}-title" data-key="research.sub_topics[${i}].title" class="content-editable-field">
                    ${topic.title}
                </h4>
                <p class="text-gray-600 content-editable-field min-h-[50px]"
                    id="research-sub-topics-${i}-content" data-key="research.sub_topics[${i}].content">
                    ${topic.content}
                </p>
            </div>
        `).join('');

        // --- 2. PERSONAL LIFE SECTION (MODIFIED FOR IMAGE SLIDER) ---
        const personalContainer = document.getElementById('personal-life-memories');
        personalContainer.innerHTML = data.personal_life.map((memory, i) => `
            <div class="flex flex-col md:flex-row bg-white p-6 rounded-xl shadow-md overflow-hidden">
                <div class="md:w-2/3 md:pr-6">
                    <h4 class="text-2xl font-semibold mb-3" style="color: var(--theme-color-600, #4f46e5);"
                        id="personal-life-${i}-title" data-key="personal_life[${i}].title" class="content-editable-field">
                        ${memory.title}
                    </h4>
                    <p class="text-gray-600 leading-relaxed content-editable-field min-h-[50px]"
                        id="personal-life-${i}-content" data-key="personal_life[${i}].content">
                        ${memory.content}
                    </p>
                    <p class="text-sm text-gray-500 mt-4">
                        Image URLs (Edit Mode Only):
                        <span class="content-editable-field break-all" data-key="personal_life[${i}].images">${(memory.images || []).join(', ')}</span>
                    </p>
                </div>
                <div class="md:w-1/3 mt-4 md:mt-0 relative overflow-hidden rounded-lg shadow-lg border border-gray-200 image-slider-container" style="aspect-ratio: 9 / 16;">
                    ${(memory.images || []).map(url => `
                        <img src="${url}" alt="${memory.title} image" class="absolute inset-0 w-full h-full object-cover transition-opacity duration-1000"
                            onerror="this.onerror=null; this.src='https://placehold.co/900x1600/6B7280/FFFFFF?text=Image+Load+Error';"
                            style="opacity: 0; display: none;" />
                    `).join('')}
                </div>
            </div>
        `).join('');

        // IMPORTANT: Initialize the sliders after rendering the content
        if (data.personal_life.some(m => m.images && m.images.length > 0)) {
            initImageSliders();
        }

        // --- 3. GALLERY SECTION (Albums) ---
        const galleryContainer = document.getElementById('gallery-albums');
        galleryContainer.innerHTML = data.gallery_albums.map((album, i) => `
            <div class="bg-white p-6 rounded-xl shadow-xl">
                <h4 class="text-2xl font-semibold mb-4" style="color: var(--theme-color-600, #4f46e5);"
                    id="gallery-album-${i}-title" data-key="gallery_albums[${i}].title" class="content-editable-field">
                    ${album.title}
                </h4>
                <p class="text-sm text-gray-500 mb-4">
                    Media URLs (Comma separated):
                    <span class="content-editable-field break-all" data-key="gallery_albums[${i}].items">${(album.items || []).join(', ')}</span>
                </p>
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                    ${(album.items || []).map(url => {
                        if (album.type === 'video') {
                            // Assume videos are embed links (YouTube, BiliBili)
                            let embedUrl = url;
                            if (url.includes('youtube.com/watch?v=')) {
                                embedUrl = url.replace('watch?v=', 'embed/');
                            }
                            return `
                                <div class="aspect-video w-full rounded-lg overflow-hidden shadow-lg border border-gray-200">
                                    <iframe class="w-full h-full" src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                </div>
                            `;
                        } else {
                            // Photos
                            return `
                                <img src="${url}" alt="${album.title} media" class="w-full aspect-square object-cover rounded-lg shadow-lg transform hover:scale-[1.02] transition duration-300"
                                    onerror="this.onerror=null; this.src='https://placehold.co/400x400/EF4444/FFFFFF?text=Media+Load+Error';" />
                            `;
                        }
                    }).join('')}
                </div>
            </div>
        `).join('');


        // --- 4. ARTICLE SECTION ---
        const articleContainer = document.getElementById('article-list');
        articleContainer.innerHTML = data.articles.map((article, i) => `
            <div class="bg-white p-5 rounded-xl shadow-sm hover:shadow-md transition duration-150 flex justify-between items-center">
                <div>
                    <a href="${article.link || '#'}" target="_blank" class="text-xl font-semibold hover:underline" style="color: var(--theme-color-600, #4f46e5);"
                       id="article-${i}-title" data-key="articles[${i}].title" class="content-editable-field">
                        ${article.title}
                    </a>
                    <p class="text-sm text-gray-500">
                        Source: <span id="article-${i}-source" data-key="articles[${i}].source" class="content-editable-field">${article.source}</span>
                        | Link (Edit Mode): <span class="content-editable-field break-all" data-key="articles[${i}].link">${article.link}</span>
                    </p>
                </div>
            </div>
        `).join('');

        // --- 5. SOCIAL LINKS (FOOTER) ---
        const socialContainer = document.getElementById('social-links-container');
        socialContainer.innerHTML = data.social_links.map((link, i) => `
            <a href="${link.url}" target="_blank" class="text-white hover:text-opacity-80 transition duration-150 text-lg font-medium"
               id="social-${i}-name" data-key="social_links[${i}].name" class="content-editable-field">
                ${link.name}
            </a>
            <span class="text-white hidden">
                URL (Edit Mode): <span class="content-editable-field break-all" data-key="social_links[${i}].url">${link.url}</span>
            </span>
        `).join('<span class="text-white">|</span>');

        // Re-apply editable attributes after content is re-rendered
        if (isEditMode) {
            document.querySelectorAll('.content-editable-field').forEach(el => {
                el.setAttribute('contenteditable', 'true');
            });
        }
    }

    /** Saves the current state of all editable fields back to Firestore. */
    async function saveContent() {
        if (!db || !userId) return console.error("Database or User ID not initialized for saving.");

        const updatedContent = JSON.parse(JSON.stringify(initialContent)); // Start with a fresh copy
        const editableElements = document.querySelectorAll('.content-editable-field');

        editableElements.forEach(el => {
            const key = el.dataset.key;
            if (!key) return;

            const value = el.textContent.trim();

            // Function to set nested property (handles array indices)
            const setNestedProperty = (obj, path, val) => {
                const parts = path.match(/[^.\[\]]+/g);
                let current = obj;
                for (let i = 0; i < parts.length; i++) {
                    const part = parts[i];
                    if (i === parts.length - 1) {
                        // Check if the property should be an array (for media URLs)
                        if (path.includes('.images') || path.includes('.items')) {
                            current[part] = val.split(',').map(s => s.trim()).filter(s => s.length > 0);
                        } else {
                            current[part] = val;
                        }
                        return;
                    }

                    let nextPart = parts[i + 1];
                    if (!current[part]) {
                        // Determine if the next part is an index (i.e., start of an array)
                        if (!isNaN(parseInt(nextPart))) {
                            current[part] = [];
                        } else {
                            current[part] = {};
                        }
                    }
                    current = current[part];
                }
            };

            setNestedProperty(updatedContent, key, value);
        });

        try {
            // Save the full public content document
            await setDoc(doc(db, CONTENT_PATH), updatedContent);
            console.log("Website content saved successfully!");
        } catch (error) {
            console.error("Error saving content to Firestore:", error);
            // Note: Using a custom modal/toast message is preferred over standard alert()
            console.warn("Failed to save content. Check the console for details.");
        }
    }

    // --- THEME COLOR FUNCTIONS ---

    function applyThemeColor(hexColor) {
        themeColorHex = hexColor;
        const style = document.documentElement.style;
        // A simplified way to set color variables based on the chosen hex
        style.setProperty('--theme-color-500', hexColor);
        style.setProperty('--theme-color-600', hexColor);
        style.setProperty('--theme-color-700', hexColor);
        style.setProperty('--theme-color-800', hexColor);

        // Set the color picker value
        document.getElementById('color-picker').value = hexColor;
    }

    async function saveThemeColor() {
        const newColor = document.getElementById('color-picker').value;
        applyThemeColor(newColor);
        document.getElementById('config-modal').classList.add('hidden');

        if (db && userId) {
            try {
                await setDoc(doc(db, CONFIG_PATH(userId)), { themeColor: newColor }, { merge: true });
                console.log("Theme color saved successfully!");
            } catch (error) {
                console.error("Error saving theme color:", error);
            }
        }
    }

    // --- INITIALIZATION & AUTHENTICATION ---

    async function initializeFirebase() {
        try {
            if (Object.keys(firebaseConfig).length === 0) {
                throw new Error("Firebase configuration is missing or empty.");
            }

            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // 1. Authentication
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (user) => {
                userId = user ? user.uid : null;
                isAuthReady = true;
                document.getElementById('user-id-display').textContent = userId || 'N/A';
                console.log("Auth State Changed. User ID:", userId);

                // 2. Load Content (Public)
                onSnapshot(doc(db, CONTENT_PATH), (docSnap) => {
                    const content = docSnap.exists() ? docSnap.data() : initialContent;
                    renderContent(content);
                    // Write initial content if the document doesn't exist
                    if (!docSnap.exists()) {
                        setDoc(doc(db, CONTENT_PATH), initialContent).catch(e => console.error("Error writing initial content:", e));
                    }
                }, (error) => {
                    console.error("Error listening to public content:", error);
                    // Render fallback content on error
                    renderContent(initialContent);
                });

                // 3. Load Settings (Private)
                if (userId) {
                    onSnapshot(doc(db, CONFIG_PATH(userId)), (docSnap) => {
                        if (docSnap.exists() && docSnap.data().themeColor) {
                            applyThemeColor(docSnap.data().themeColor);
                        } else {
                            applyThemeColor(themeColorHex); // Apply default
                        }
                    }, (error) => {
                        console.warn("Could not load private settings, using default theme.", error);
                        applyThemeColor(themeColorHex); // Apply default on error
                    });
                }
            });

            document.getElementById('edit-mode-toggle').addEventListener('click', () => {
                // Only the authenticated user can use edit mode (since their settings doc is tied to their auth token)
                if (userId) {
                    toggleEditMode(!isEditMode);
                } else {
                    // Using console.warn instead of alert() per guidelines
                    console.warn("Cannot enable Edit Mode. Authentication failed or user is not recognized as the owner.");
                    // Optional: show a simple on-screen modal instead of alert
                }
            });

        } catch (error) {
            document.getElementById('loading-indicator').innerHTML = `
                <p class="text-red-600 text-lg">Error Initializing Firebase:</p>
                <p class="text-red-500 text-sm mt-2">The application could not load its content database. Please check console for details.</p>
            `;
            console.error("Firebase initialization failed:", error);
            renderContent(initialContent); // Render initial dummy content
        }
    }

    // Initialize the app on page load
    document.getElementById('current-year').textContent = new Date().getFullYear();
    initializeFirebase();

    // Make saveThemeColor globally available for the button click in the modal
    window.saveThemeColor = saveThemeColor;

    // Add event listener to save content when the browser is closed or refreshed while in edit mode
    window.addEventListener('beforeunload', () => {
        if (isEditMode) {
            // Note: saveContent is an async function, but beforeunload does not wait for promises.
            // We trust the Firestore SDK to handle the pending write operation.
            saveContent();
        }
    });
</script>
